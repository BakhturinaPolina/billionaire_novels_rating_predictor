# Category Mapping: Topic Labels → Theory-Aligned Categories

This module implements deterministic mapping from OpenRouter-generated topic labels to theory-aligned thematic categories. It bridges the gap between automated topic labeling (OpenRouter experiments) and statistical analysis (Stage 07), operationalizing theoretical constructs from Radway (1984), Propp functions, and Ogas & Gaddam (2011).

## Overview

The category mapping stage takes human-readable topic labels (generated by OpenRouter API experiments) and maps them to 19 theory-aligned categories:

- **A-P**: 16 thematic composites matching the research framework
- **Q**: Miscommunication vs Repair (cross-cutting)
- **R**: Protectiveness vs Jealousy (cross-cutting)
- **S**: Scene Anchors (auxiliary, for qualitative analysis)

Each topic receives soft one-hot category assignments (weights sum to 1.0), enabling topics to map to multiple categories when semantically appropriate.

## Theory-Aligned Category Schema

### Core Composites (A-P)

#### A. Reassurance/Commitment (`A_commitment_hea`)

**Theoretical Foundation**: HEA (Happily Ever After) centrality in romance novels; Propp functions #8–#11 (proposal/commitment); compensatory safety via stable love (Radway, 1984).

**Subcodes**: commitment_hea, vows_proposals, reunion_HEA, gifts_symbolic

**Hypotheses/Indices**: 
- HEA Index (primary component)
- Love-over-Sex (positive term)

**Example Topics**: "Wedding Planning", "Engagement Surprise", "Reunion Supplication", "Eternal Love"

**Regex Patterns**: `wedding`, `engagement`, `vow`, `reunion`, `homecoming`, `eternal`, `proposal`, `commitment`, `married`, `marriage`

---

#### B. Mutual Intimacy (Non-Explicit) (`B_mutual_intimacy`)

**Theoretical Foundation**: Love-over-sex preference; first tenderness → warm response in Radway's narrative arc; emotional connection over physical explicitness.

**Subcodes**: kissing_touch, bedtime_intimacy, foreplay_tender

**Hypotheses/Indices**: 
- Love-over-Sex (positive term)
- Miscommunication Balance (repair via tenderness)

**Example Topics**: "Bedtime Intimacy", "Armchair Foreplay", "Tender Tongue Play", "Intimate Touch"

**Regex Patterns**: `foreplay`, `bedtime intimacy`, `armchair foreplay`, `first intimacy`, `intimate touch`, `bedroom intimacy`, `kiss`, `caress`, `tender`, `tenderness`, `intimate`, `touching`

---

#### C. Explicit Eroticism (`C_explicit`)

**Theoretical Foundation**: Contrast against B (mutual intimacy); explicitness ratio operationalization; explicit content as negative term in Love-over-Sex hypothesis.

**Subcodes**: genitals_explicit, orgasm_events, toys_kinks

**Hypotheses/Indices**: 
- Explicitness Ratio (numerator)
- Love-over-Sex (negative term)

**Example Topics**: "Tongue & Thumb Play", "Moaning Intimacy", "Condom Mishap", "Erotic Nipple Play"

**Regex Patterns**: `nipple|nipples|clit|orgasm|dominatrix|condom|moaning intimacy|wet nude|breast play|tongue & thumb`, `explicit|erotic|sexual|arousal|pleasure|pussy|erection`

---

#### D. Power/Wealth/Luxury (`D_luxury_wealth_status`)

**Theoretical Foundation**: Luxury as therapeutic safety; wealth as protector; luxury × (commitment+tenderness) interaction (H3).

**Subcodes**: luxury_consumption, luxury_settings, status_symbols

**Hypotheses/Indices**: 
- Luxury Saturation
- Luxury × (A+B) interaction (H3)

**Example Topics**: "Lacy Lingerie", "Wine Service", "Eligible Millionaire", "Tailored Intimacy"

**Regex Patterns**: `lacy lingerie`, `wine service`, `millionaire|hollywood|luxury car|stainless|margarita`, `wealthy|richest|wealthiest|wealth|businessman|dollar|expensive|tailored`

---

#### E. Coercion/Brutality/Danger (`E_threat_danger`)

**Theoretical Foundation**: Disliked darkness; contrast with tenderness; operationalizes "dark" in Dark-vs-Tender hypothesis.

**Subcodes**: threat_violence_dark, policing_surveillance, stalker_coercion

**Hypotheses/Indices**: 
- Dark-vs-Tender (positive term)

**Example Topics**: "Police Encounter", "Dangerous Liaison", "Stony Threat", "Gunplay"

**Regex Patterns**: `police|law enforcement|dangerous liaison|stalker|coercion|weapons|threat`, `danger|violence|dark|murder|gun|weapon`

---

#### F. Angst/Negative Affect (`F_negative_affect`)

**Theoretical Foundation**: Emotional escape vs angst; Radway's early arc conflict; negative affect as contrast to tenderness.

**Subcodes**: fear_anxiety_panic, anger_outbursts, guilt_shame

**Hypotheses/Indices**: 
- Dark-vs-Tender (positive term)
- Miscommunication Balance (negative term)

**Example Topics**: "Emotional Panic", "Mutual Outbursts", "Ashamed Confession", "Fear and Anxiety", "Raging Tempers"

**Regex Patterns**: `panic|outburst|angry|rage|guilty|shame|nightmare|sleep deprivation|wrong thoughts|ashamed`, `fear|anxiety|sad|tears|tearful|hurt|pain|guilt|anger|furious|frustration`

---

#### G. Courtship Rituals/Gifts (`G_rituals_gifts`)

**Theoretical Foundation**: Romantic rituals; symbolic provisioning; contributes to HEA Index.

**Subcodes**: dates_gifts_flowers, festive_rituals

**Hypotheses/Indices**: 
- HEA Index (adds to A)

**Example Topics**: "Dating App Dilemma", "Victorian Holiday Celebration", "Yellow Bouquet", "Birthday Surprise"

**Regex Patterns**: `bouquet|birthday|holiday|celebration|gift|dating app`, `flowers|roses|presents|ritual|ceremony|festive`

---

#### H. Domestic Nesting (`H_domestic_nesting`)

**Theoretical Foundation**: Compensatory safety (home as refuge); baseline comfort for escape reading.

**Subcodes**: home_coziness, bathroom_shower, kitchen_meals, bedtime_sleep

**Hypotheses/Indices**: 
- Family/Fertility (overlap)
- Baseline comfort for escape

**Example Topics**: "Bedtime Intimacy", "Kitchen Squabble", "Wine Service", "Cozy Interior", "Bathroom Hygiene"

**Regex Patterns**: `bed|bedroom|sheets|kitchen|dinner|bathroom|shower|cozy|wine service|bedtime`, `home|domestic|nesting|furniture|fireplace|bath|tub`

---

#### I. Humor/Lightness (`I_humor_lightness`)

**Theoretical Foundation**: Binge-readability; escape via lightness; descriptive covariate.

**Subcodes**: banter_wit, playful_laughter

**Hypotheses/Indices**: 
- Descriptive covariate

**Example Topics**: "Playful Laughter", "Gleeful Smiles", "Goofy Grins", "Sarcastic Jokes"

**Regex Patterns**: `playful|gleeful|goofy|witty|banter|jokes|spectacle`, `laugh|laughter|smile|grin|funny|humor|amusing`

---

#### J. Social Support/Kin (`J_family_support`)

**Theoretical Foundation**: Stable social buffers in HEA; caregiving signals; family as support structure.

**Subcodes**: family, parenting, confidantes

**Hypotheses/Indices**: 
- Family/Fertility Index

**Example Topics**: "Family Legacy", "New Parent Intimacy", "Giggling Confidante", "Family Dynamics"

**Regex Patterns**: `family|parents|children|pregnancy|baby|new parent|confidante`, `mother|father|sister|brother|kids|parenting|infant`

---

#### K. Professional Intrusion (`K_work_corporate`)

**Theoretical Foundation**: Office romance trope; work/love tension; corporate frame as narrative device.

**Subcodes**: office_space, meetings_board, taboo_office_romance

**Hypotheses/Indices**: 
- Corporate Frame Share

**Example Topics**: "Office Drama", "Taboo Office Kiss", "Boardroom Tension", "Office Romance", "Corporate Takeover"

**Regex Patterns**: `office|board|manager|negotiation|taboo office kiss|presentation|workstation|ipo`, `business|company|corporate|meeting|job|work|ceo|employee`

---

#### L. Vices/Addictions (`L_vices_addictions`)

**Theoretical Foundation**: Escape contrast; may reduce appeal; contributes to "dark" themes.

**Subcodes**: intoxication_benders

**Hypotheses/Indices**: 
- Covariate
- Can contribute to "dark"

**Example Topics**: "Drunken Decadence", "Wine Service" (when alcohol-focused)

**Regex Patterns**: `drunken|hangover|bender|decadence`, `drunk|alcohol|wine|whiskey|intoxication`

---

#### M. Health/Recovery/Growth (`M_health_recovery`)

**Theoretical Foundation**: Protective care; vulnerability → tenderness; part of repair arc.

**Subcodes**: medical_intimacy, healing_reveals

**Hypotheses/Indices**: 
- Can support A/B
- Part of repair

**Example Topics**: "Tremulous Reveal", "Medical Intimacy", "Health/Recovery contexts within intimacy"

**Regex Patterns**: `clinic|physician|fever|injur|tremulous reveal|medical`, `hospital|doctor|surgery|trauma|health|recovery|healing`

---

#### N. Separation/Reunion (`N_separation_reunion`)

**Theoretical Foundation**: Propp/Radway separation → tenderness → proposal; time-course hypothesis (H6).

**Subcodes**: separation_distance, reunion_confession

**Hypotheses/Indices**: 
- Time-course H6 (rises toward end)

**Example Topics**: "Distance Excuses", "Reunion Supplication", "Time Apart", "Long-Awaited Reunion"

**Regex Patterns**: `separation|apart|distance|reunion|homecoming`, `away|leaving|return|together|apart`

---

#### O. Aesthetics/Appearance (`O_appearance_aesthetics`)

**Theoretical Foundation**: "Detective agency" (physical/cultural cues) shaping selectivity; appearance intensity as covariate.

**Subcodes**: gaze_face, hair_makeup_lingerie, scent

**Hypotheses/Indices**: 
- Appearance intensity (covariate)
- Can interact with D (luxury)

**Example Topics**: "Gaze & Brows", "Hair Play", "Lacy Lingerie", "Lingering Scents", "Hollywood Gaze"

**Regex Patterns**: `gaze|brows|eye contact|hair play|lingerie|perfume|scent|mirror`, `appearance|looks|attractive|beautiful|handsome|stunning|aesthetic`

---

#### P. Tech/Media Presence (`P_tech_media`)

**Theoretical Foundation**: Modern courtship infrastructure; communication devices as narrative elements.

**Subcodes**: comms_devices, public_image_scandal

**Hypotheses/Indices**: 
- Comms Density

**Example Topics**: "Vibrating Phones", "Tabloid Scandal", "Webcam Flirtation", "Ringing Phones"

**Regex Patterns**: `phone|phones|vibrating|ringing|webcam|tabloid|screen|message`, `tech|media|communication|device|cellphone|text|call`

---

### Cross-Cutting Categories

#### Q. Miscommunication vs Repair (`Q_miscomm_vs_repair`)

**Theoretical Foundation**: Radway's mid-arc misunderstanding → reinterpretation → repair; operationalizes conflict-to-resolution arc.

**Subcodes**: miscommunication_deception, apology_repair

**Hypotheses/Indices**: 
- Miscommunication Balance (split 50/50: miscomm vs repair)

**Example Topics**: "Whispered Doubts", "Shameless Apologies", "Deceptive Lies", "Apology & Forgiveness"

**Regex Patterns**: `lie|deception|doubts|miscommunication|apology|forgiveness|repair`, `wrong|mistake|sorry|apologetic|truth|deceive|confession`

---

#### R. Protectiveness vs Jealousy (`R_protect_vs_jealous`)

**Theoretical Foundation**: "Strong but gentle"; readers dislike raw possessiveness; caring protectiveness valued over jealousy (H4).

**Subcodes**: protectiveness_care, jealousy_possessiveness

**Hypotheses/Indices**: 
- Protective–Jealousy Delta (H4) (split 50/50: protect vs jealous)

**Example Topics**: "Overprotective Gentlemen's Promise", "Jealous Girlfriend", "Protective Conversations"

**Regex Patterns**: `protect|protective|overprotective|jealous`, `jealousy|possessiveness|care|guardian|guard`

---

### Auxiliary Categories

#### S. Scene Anchors (`S_scene_anchor`)

**Theoretical Foundation**: Formulaic scene kits (Propp-like "functions"); segmentation and qualitative sampling.

**Subcodes**: elevators_halls, vehicles_rides, bars_kitchens_bathrooms, sunsets_beaches

**Role**: Segmentation and qualitative sampling (optional in indices)

**Example Topics**: "Elevator Encounters", "Driveway Encounter", "Barroom Moment", "Sunset Stroll", "Airport Encounter"

**Regex Patterns**: `elevator|doorways|driveway|airport|boat|barroom|sunset|beach|silent ride|kitchen|bathroom`, `door|car|vehicle|flight|plane|stairs|hallway|lobby`

---

## Tagging Logic

### Regex-Based Inference

The mapping uses case-insensitive regex patterns to match topic labels to categories:

1. **Primary Matching**: Each category has a list of regex patterns. If any pattern matches the label, the topic is assigned to that category.

2. **Soft Assignments**: When multiple categories match, weights are normalized to sum to 1.0 (equal weights: `1.0 / num_matches`).

3. **Fallback Heuristics**: If no patterns match, fallback logic uses coarse POS-like heuristics:
   - Eye/gaze cues → `O_appearance_aesthetics` + `I_humor_lightness`
   - Bedroom/kitchen cues → `H_domestic_nesting` + `S_scene_anchor`
   - Relationship cues → `A_commitment_hea`
   - Place-like cues → `S_scene_anchor`

### Example Mappings

- **"Wedding Planning"** → `A_commitment_hea` (1.0)
- **"Tender Tongue Play"** → `B_mutual_intimacy` (1.0)
- **"Tongue & Nipple Play"** → `C_explicit` (1.0)
- **"Lacy Lingerie"** → `D_luxury_wealth_status` + `O_appearance_aesthetics` (0.5 each)
- **"Police Encounter"** → `E_threat_danger` + `S_scene_anchor` (0.5 each)
- **"Emotional Panic"** → `F_negative_affect` (1.0)
- **"Yellow Bouquet"** → `G_rituals_gifts` (1.0)
- **"Kitchen Squabble"** → `H_domestic_nesting` + `S_scene_anchor` (0.5 each)
- **"Playful Laughter"** → `I_humor_lightness` (1.0)
- **"Family Legacy"** → `J_family_support` (1.0)
- **"Office Romance"** → `K_work_corporate` (1.0)
- **"Drunken Decadence"** → `L_vices_addictions` (1.0)
- **"Tremulous Reveal"** → `M_health_recovery` (1.0)
- **"Long-Awaited Reunion"** → `N_separation_reunion` + `A_commitment_hea` (0.5 each)
- **"Gaze & Brows"** → `O_appearance_aesthetics` (1.0)
- **"Vibrating Phones"** → `P_tech_media` (1.0)
- **"Apology & Forgiveness"** → `Q_miscomm_vs_repair` (1.0)
- **"Jealous Girlfriend"** → `R_protect_vs_jealous` (1.0)
- **"Elevator Encounters"** → `S_scene_anchor` (1.0)

---

## Connection to Hypotheses

### H1: Love-over-Sex Hypothesis
```
(commitment_hea + tenderness_emotion) > explicit in Top vs Trash
```
**Categories**: `A_commitment_hea` + `B_mutual_intimacy` vs `C_explicit`

### H2: HEA Index Hypothesis
```
HEA Index higher in Top
```
**Categories**: `A_commitment_hea` + `G_rituals_gifts` (symbolic_gifts + festive_rituals)

### H3: Luxury × Love Interaction
```
Luxury Saturation predicts Top only when (commitment_hea + tenderness_emotion) is high
```
**Categories**: `D_luxury_wealth_status` × (`A_commitment_hea` + `B_mutual_intimacy`)

### H4: Protectiveness vs Possessiveness
```
protectiveness_care − jealousy_possessiveness is higher in Top
```
**Categories**: `R_protect_vs_jealous` (split 50/50: protectiveness vs jealousy)

### H5: Darkness vs Tenderness
```
(neg_affect + threat_violence_dark) − tenderness_emotion is lower in Top
```
**Categories**: (`F_negative_affect` + `E_threat_danger`) − `B_mutual_intimacy`

### H6: Narrative Arc (Time-Course)
```
begin→end: miscommunication/neg_affect ↓; commitment_hea/apology_repair ↑
```
**Categories**: `Q_miscomm_vs_repair` (miscomm ↓, repair ↑), `F_negative_affect` ↓, `A_commitment_hea` ↑

---

## Derived Indices

The module computes all indices from `SCIENTIFIC_README.md`:

1. **Love-over-Sex**: `(A_commitment_hea + B_mutual_intimacy) - C_explicit`
2. **HEA Index**: `A_commitment_hea + G_rituals_gifts + G_rituals_gifts` (symbolic_gifts + festive_rituals)
3. **Explicitness Ratio**: `C_explicit / (C_explicit + A_commitment_hea + B_mutual_intimacy + 1e-9)`
4. **Luxury Saturation**: `D_luxury_wealth_status`
5. **Corporate Frame Share**: `K_work_corporate`
6. **Family/Fertility Index**: `J_family_support`
7. **Comms Density**: `P_tech_media`
8. **Dark-vs-Tender**: `(F_negative_affect + E_threat_danger) - B_mutual_intimacy`
9. **Miscommunication Balance**: `(A_commitment_hea + B_mutual_intimacy + Q_repair) - Q_miscomm`
10. **Protective–Jealousy Delta**: `R_protectiveness - R_jealousy` (from `R_protect_vs_jealous` split 50/50)

---

## Usage

### Basic Usage

```bash
python -m src.stage06_labeling.category_mapping.main_category_mapping \
    --labels results/stage06_labeling_openrouter/labels_pos_openrouter_romance_aware_paraphrase-MiniLM-L6-v2.json \
    --outdir results/stage06_labeling/category_mapping
```

### With Book-Level Aggregation

If you have book-topic probability data, you can aggregate to book-level and compute indices:

```bash
python -m src.stage06_labeling.category_mapping.main_category_mapping \
    --labels results/stage06_labeling_openrouter/labels_pos_openrouter_romance_aware_paraphrase-MiniLM-L6-v2.json \
    --book-topic-probs data/processed/book_topic_probs.csv \
    --outdir results/stage06_labeling/category_mapping
```

### With Config File

```bash
python -m src.stage06_labeling.category_mapping.main_category_mapping \
    --labels results/stage06_labeling_openrouter/labels_pos_openrouter_romance_aware_paraphrase-MiniLM-L6-v2.json \
    --config configs/paths.yaml \
    --outdir results/stage06_labeling/category_mapping
```

---

## Output Files

### Required Outputs

1. **`topic_to_category_probs.json`**
   - Format: `{"topic_id": {"category": weight, ...}, ...}`
   - Per-topic soft category assignments (weights sum to 1.0)

2. **`topic_to_category_final.csv`**
   - Columns: `topic_id`, `label`, `category`, `weight`
   - Flat table format for inspection

### Optional Outputs (if `--book-topic-probs` provided)

3. **`book_category_props.csv`**
   - Columns: `book_id`, `category`, `value`
   - Book-level category proportions (aggregated from topic probabilities)

4. **`indices_book.csv`**
   - Columns: `book_id`, `Love_over_Sex`, `HEA_Index`, `Explicitness_Ratio`, `Luxury_Saturation`, `Corporate_Frame_Share`, `Family_Fertility_Index`, `Comms_Density`, `Dark_vs_Tender`, `Miscommunication_Balance`, `Protective_minus_Jealousy`
   - All derived indices per book

---

## Integration with Pipeline

### Stage Flow

1. **Stage 06: OpenRouter Experiments** → Generate topic labels
   - Output: `labels_pos_openrouter_romance_aware_paraphrase-MiniLM-L6-v2.json`

2. **Stage 06: Category Mapping** (this module) → Map labels to categories
   - Input: Labels JSON from OpenRouter experiments
   - Output: `topic_to_category_probs.json`, `topic_to_category_final.csv`
   - Optional: Book-level aggregates and indices

3. **Stage 07: Statistical Analysis** → Use category mappings for hypothesis testing
   - Input: Category mappings and indices
   - Output: Statistical tests, visualizations, reports

### Data Contracts

Outputs match specifications in `docs/DATA_CONTRACTS.md`:
- `topic_to_category_probs.json` → Used for topic-to-composite mapping
- `book_category_props.csv` → Used for book-level analysis
- `indices_book.csv` → Used for hypothesis testing

---

## Theoretical Foundations

### Radway (1984): Reading the Romance

- **Compensatory escape**: Categories A (commitment), B (tenderness), H (domestic nesting) operationalize safety/escape
- **Narrative arc**: Categories Q (miscomm→repair), N (separation→reunion) capture Radway's conflict-to-resolution progression
- **Selectivity**: Category O (appearance) captures "detective agency" (physical/cultural cues)

### Propp Functions

- **Functions #8–#11**: Category A (commitment/HEA) operationalizes proposal/commitment functions
- **Scene functions**: Category S (scene anchors) captures formulaic scene kits

### Ogas & Gaddam (2011): A Billion Wicked Thoughts

- **Love-over-sex preference**: Categories B (mutual intimacy) vs C (explicit) operationalize this preference
- **Protectiveness vs jealousy**: Category R captures "strong but gentle" preference

---

## Extending the Mapping

### Adding New Patterns

To add new regex patterns, edit `map_topics_to_categories.py`:

```python
TRIG = {
  "A_commitment_hea": [
    r"wedding", r"engagement",
    # Add new patterns here
    r"new_pattern",
  ],
  # ...
}
```

### Refining Category Splits

For categories Q and R, the current implementation splits 50/50. To refine:

1. Add subcode detection logic
2. Adjust split ratios based on label content
3. Update `compute_indices()` accordingly

---

## See Also

- **OpenRouter Experiments**: `src/stage06_labeling/openrouter_experiments/`
- **Main Labeling Module**: `src/stage06_labeling/generate_labels.py`
- **Scientific Methodology**: `SCIENTIFIC_README.md`
- **Data Contracts**: `docs/DATA_CONTRACTS.md`

---

## References

- Radway, J. A. (1984). *Reading the Romance: Women, Patriarchy, and Popular Literature*. University of North Carolina Press.
- Ogas, O., & Gaddam, S. (2011). *A Billion Wicked Thoughts: What the Internet Tells Us About Sexual Relationships*. Dutton.
- Propp, V. (1968). *Morphology of the Folktale* (2nd ed.). University of Texas Press.

